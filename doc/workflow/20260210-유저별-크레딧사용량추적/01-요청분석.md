# 요청 분석: 20260210-유저별-크레딧사용량추적

## 작업 개요

| 항목 | 내용 |
|------|------|
| **작업 ID** | 20260210-유저별-크레딧사용량추적 |
| **분석 일시** | 2026-02-10 |
| **요청 요약** | 유저별 크레딧(API 토큰) 사용량을 추적하기 위한 데이터 테이블과 기록 로직을 추가합니다. UI 표시는 불필요하며, 관리/분석 목적의 데이터 레이어만 구현합니다. |

## 요구사항

### 기능 요구사항

1. credit_usage_logs 테이블 생성 (유저별 토큰 사용 이력 저장)
2. 채팅(LLM 호출) 시 사용량을 credit_usage_logs에 자동 기록
3. PDF 임베딩 시 사용량을 credit_usage_logs에 자동 기록 (가능한 경우)
4. 유저별 사용량 집계 RPC 함수 제공 (get_user_credit_usage_summary)

### 비기능 요구사항

- 사용량 기록은 non-blocking (기록 실패 시에도 원래 응답 정상 반환)
- RLS 정책 적용 (유저 자신의 데이터만 조회 가능)
- 로그 데이터는 수정/삭제 불가 (immutable logs)

## 작업 범위

| 영역 | 작업 내용 |
|------|-----------|
| **Schema** | credit_usage_logs 테이블, 인덱스, RLS, get_user_credit_usage_summary RPC 함수 추가 |
| **Backend** | 채팅 API(/api/chat)에 사용량 기록 로직 추가, PDF 임베딩 API에도 기록 추가 (가능 시) |
| **Frontend** | 해당 없음 (사용자 요청에 따라 UI 변경 불필요) |

## 완료 조건

- [ ] credit_usage_logs 테이블이 생성되고 RLS가 적용됨
- [ ] 채팅 응답 후 credit_usage_logs에 사용량이 자동 기록됨
- [ ] 사용량 기록 실패 시에도 채팅 응답은 정상 반환됨
- [ ] get_user_credit_usage_summary RPC로 유저별 집계 조회 가능
- [ ] 기존 기능(채팅, PDF 업로드 등)에 영향 없음

## 실행 계획

| 순서 | 에이전트 | 작업 내용 |
|------|----------|-----------|
| 1 | supabase-schema-developer | credit_usage_logs 테이블, 인덱스, RLS, RPC 함수 추가 |
| 2 | backend-developer | 채팅/임베딩 API에 사용량 기록 로직 추가 |
| 3 | reviewer | 스키마 변경과 백엔드 로직의 품질, 보안, 정합성 검증 |

## 리스크 및 주의사항

- chat_messages.usage의 total_cost가 현재 0으로 고정되어 있어 비용 추적은 향후 개선 필요
- 임베딩 API(embedText/embedMany)에서 usage 정보를 반환하지 않을 수 있음 — 확인 필요
- 사용량 기록 insert가 채팅 응답 시간에 미치는 영향 (non-blocking 처리로 완화)

---
*생성: Orchestrator | 일시: 2026-02-10*
