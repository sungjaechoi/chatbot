# 요청 분석: 20260209-채팅-히스토리-연속성

## 작업 개요

| 항목 | 내용 |
|------|------|
| **작업 ID** | 20260209-채팅-히스토리-연속성 |
| **분석 일시** | 2026-02-09 00:00 |
| **요청 요약** | RAG 채팅 시 이전 대화 히스토리가 LLM에 전달되지 않아 대화 연속성이 없는 문제를 해결. DB에 저장된 대화 히스토리를 RAG 파이프라인에 주입하여 맥락 있는 답변을 제공하도록 수정. |

## 요구사항

### 기능 요구사항

1. RAG 파이프라인에 이전 대화 히스토리를 전달하여 LLM이 맥락을 이해하도록 함
2. DB에 저장된 대화 히스토리를 조회하여 최근 N턴만 LLM에 전달
3. 히스토리가 없는 첫 대화에서도 기존처럼 정상 동작
4. 에러 메시지(is_error=true)는 히스토리에서 제외

### 비기능 요구사항

- 토큰 초과 방지를 위한 히스토리 메시지 수 제한 (환경변수로 설정 가능)
- DB 조회 추가로 인한 응답 지연 최소화

## 작업 범위

| 영역 | 작업 내용 |
|------|-----------|
| **Backend** | RAG 파이프라인(rag.ts, llm.ts)에 히스토리 파라미터 추가, chat route에서 DB 히스토리 조회 후 전달 |
| **Frontend** | 백엔드가 서버사이드 DB 조회를 하므로 프론트엔드 변경 최소 - 기능 동작 확인 중심 |

## 완료 조건

- [ ] 후속 질문 시 LLM이 이전 대화 맥락을 이해하여 답변
- [ ] 히스토리 메시지 수 제한으로 토큰 초과 방지
- [ ] 첫 대화, 히스토리 없는 경우 기존처럼 정상 동작
- [ ] 기존 기능(RAG 검색, 소스 반환, usage 추적) 정상 유지
- [ ] 페이지 새로고침 후에도 대화 연속성 유지

## 실행 계획

| 순서 | 에이전트 | 작업 내용 |
|------|----------|-----------|
| 1 | backend-developer | RAG 파이프라인에 히스토리 주입, chat route에서 DB 히스토리 조회 연동 |
| 2 | frontend-developer | 프론트엔드 동작 확인 및 필요 시 수정 |
| 3 | reviewer | 코드 품질, 토큰 제한 로직, 기존 기능 호환성 검증 |

## 리스크 및 주의사항

- 히스토리 포함 시 토큰 사용량 증가로 API 비용 상승 가능
- streamText의 messages와 prompt 옵션 동시 사용 불가 - API 변경 필요
- 긴 대화의 경우 토큰 제한 초과 가능성

---
*생성: Orchestrator | 일시: 2026-02-09 00:00*
