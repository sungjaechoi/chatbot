# 최종 결과 보고: 20260209-채팅-히스토리-연속성

## 결과 요약

| 항목 | 내용 |
|------|------|
| **작업 ID** | 20260209-채팅-히스토리-연속성 |
| **시작 일시** | 2026-02-09 |
| **완료 일시** | 2026-02-09 |
| **최종 상태** | ✅ PASS |
| **총 재작업 횟수** | 2회 |

## 완료 조건 충족 여부

| 조건 | 상태 | 비고 |
|------|------|------|
| 후속 질문 시 LLM이 이전 대화 맥락을 이해하여 답변 | ✅ 충족 | DB에서 히스토리 조회 → RAG 파이프라인에 chatHistory 주입 |
| 히스토리 메시지 수 제한으로 토큰 초과 방지 | ✅ 충족 | `CHAT_HISTORY_LIMIT` 환경변수 (기본값 10) |
| 첫 대화, 히스토리 없는 경우 기존처럼 정상 동작 | ✅ 충족 | chatHistory가 비어있으면 기존 단일 prompt 모드 사용 |
| 기존 기능(RAG 검색, 소스 반환, usage 추적) 정상 유지 | ✅ 충족 | 기존 로직 변경 없이 히스토리 파라미터만 추가 |
| 페이지 새로고침 후에도 대화 연속성 유지 | ✅ 충족 | ChatPageClient에서 loadHistory 호출로 DB 히스토리 복원 |

## 생성/수정된 파일

### Backend

| 파일 경로 | 변경 유형 | 설명 |
|-----------|-----------|------|
| `src/shared/types/index.ts` | modified | `ChatHistoryMessage` 인터페이스 추가 |
| `src/shared/lib/langchain/llm.ts` | modified | `generateAnswer`에 `chatHistory` 파라미터 추가, messages 배열 형식 지원 |
| `src/shared/lib/langchain/rag.ts` | modified | `executeRAGPipeline`에 `chatHistory` 파라미터 추가 및 전달 |
| `src/app/api/chat/route.ts` | modified | DB 히스토리 조회 후 RAG 파이프라인에 전달, `is_error` 메시지 필터링 |
| `src/app/api/chat/history/route.ts` | created | `GET /api/chat/history?pdfId=xxx` 엔드포인트 (프론트엔드 히스토리 로드용) |

### Frontend

| 파일 경로 | 변경 유형 | 설명 |
|-----------|-----------|------|
| `src/shared/stores/chatStore.ts` | modified | `isLoadingHistory`, `historyError`, `pdfId` 상태 추가, `loadHistory` 액션 구현 |
| `src/features/chat/ChatPageClient.tsx` | created | 채팅 페이지 클라이언트 컴포넌트, `loadHistory` useEffect 연동 |
| `src/features/chat/ChatContainer.tsx` | modified | `isLoadingHistory`, `historyError` 스토어 추출 및 ChatView에 전달 |
| `src/features/chat/ChatView.tsx` | modified | `isLoadingHistory`, `historyError` props 추가, 하위 컴포넌트에 전달 |
| `src/features/chat/MessageListView.tsx` | modified | `HistoryLoadingIndicator`, `HistoryErrorState`, `HistoryErrorBanner` 컴포넌트 추가, 스크롤 동작 분기(instant/smooth) |
| `src/features/chat/MessageInputView.tsx` | modified | `isLoadingHistory`, `historyError` props 추가, 히스토리 로딩 중 입력 비활성화 |

## 주요 변경 사항

### 1. RAG 파이프라인 히스토리 주입 (Backend)

- `chat/route.ts`에서 `getMessages()`로 DB 히스토리 조회 후 `executeRAGPipeline()`에 전달
- `is_error=true` 메시지 필터링, 최근 N개(`CHAT_HISTORY_LIMIT`) 제한
- `llm.ts`에서 히스토리가 있으면 `messages` 배열 형식, 없으면 기존 `prompt` 형식 사용
- role 리터럴 타입 안전성 확보 (`'user' as const` / `'assistant' as const`)

### 2. 프론트엔드 히스토리 로드 UX (Frontend)

- `chatStore`에 `loadHistory` 액션 추가: `/api/chat/history` API 호출하여 메시지 복원
- `isLoadingHistory` 가드로 중복 호출 방지
- `pdfId` 추적으로 stale response 감지 및 무시
- 로딩 중 입력 비활성화, placeholder 변경

### 3. Race Condition 방지

- `loadHistory` 진입 시 `isLoadingHistory` 가드
- 응답 수신 시 `pdfId` 비교로 stale response 감지
- 모든 stale response 분기에서 `isLoadingHistory: false` 리셋 (데드락 방지)

### 4. 에러 처리 UX

- `historyError` 상태로 히스토리 로드 실패 피드백
- 메시지가 있을 때: 인라인 `HistoryErrorBanner` 표시 (메시지 위)
- 메시지가 없을 때: 전체 화면 `HistoryErrorState` 표시
- 에러 시에도 새 질문 입력 가능 (graceful degradation)

## API 변경

| Method | Endpoint | 변경 내용 |
|--------|----------|-----------|
| GET | `/api/chat/history?pdfId=xxx` | 신규 추가 - 특정 PDF의 채팅 히스토리 조회 |
| POST | `/api/chat` | 내부 변경 - DB 히스토리 조회 후 RAG 파이프라인에 전달 (요청/응답 스펙 변경 없음) |

## 미해결 사항

없음

## 후속 작업 권장

1. 히스토리 포함 시 토큰 사용량 증가 모니터링 및 비용 추적
2. 긴 대화에서의 토큰 초과 방지를 위한 히스토리 요약(summarization) 기능 검토

---
*생성: Orchestrator | 일시: 2026-02-09*
