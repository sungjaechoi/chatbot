# 최종 결과 보고: 20260210-회원탈퇴-30일삭제

## 결과 요약

| 항목 | 내용 |
|------|------|
| **작업 ID** | 20260210-회원탈퇴-30일삭제 |
| **시작 일시** | 2026-02-10 12:00 |
| **완료 일시** | 2026-02-10 13:30 |
| **최종 상태** | ✅ PASS |
| **총 재작업 횟수** | 2회 |

## 완료 조건 충족 여부

| 조건 | 상태 | 비고 |
|------|------|------|
| 사용자가 UI에서 회원 탈퇴를 요청할 수 있다 | ✅ 충족 | ChatSidebar 유저 푸터 + CollectionListView 유저 프로필 영역 양쪽에서 접근 가능 |
| 탈퇴 요청 시 profiles.deleted_at이 설정되고 Supabase Auth에서 ban 처리된다 | ✅ 충족 | POST /api/account/delete에서 소프트 딜리트 + auth.admin.updateUserById ban 처리 |
| 탈퇴 유저는 즉시 로그인이 차단된다 | ✅ 충족 | 876000h (100년) ban_duration 설정으로 실질적 영구 ban |
| 30일 경과 후 크론 실행 시 해당 유저의 모든 데이터가 삭제된다 | ✅ 충족 | cleanup_deleted_users RPC(Storage 삭제) + auth.admin.deleteUser(CASCADE 삭제) 조합 |
| 탈퇴 확인 모달에 30일 유예기간 안내가 표시된다 | ✅ 충족 | AccountDeleteModal에 안내 문구 + '탈퇴합니다' 입력 검증 |
| 기존 디자인 시스템과 일관된 UI | ✅ 충족 | Editorial Luxury 테마 CSS vars, focus-ring, rounded-3xl 패턴 준수 |

## 생성/수정된 파일

### Schema

| 파일 경로 | 변경 유형 | 설명 |
|-----------|-----------|------|
| supabase/schema.sql | modified | profiles 테이블에 deleted_at, deletion_scheduled_at 컬럼 추가. idx_profiles_deletion_scheduled 일반 인덱스 추가. cleanup_deleted_users() RPC 함수 추가. 마이그레이션/롤백 SQL 주석 추가. |

### Backend

| 파일 경로 | 변경 유형 | 설명 |
|-----------|-----------|------|
| src/app/api/account/delete/route.ts | created | 회원 탈퇴 API (POST). 인증 확인 -> 이미 탈퇴 확인(409) -> profiles 소프트 딜리트 -> Auth ban 처리. |
| src/app/api/cron/cleanup-users/route.ts | created | 소프트 딜리트 유저 영구 삭제 크론 API (GET). CRON_SECRET 검증 -> cleanup_deleted_users RPC -> auth.admin.deleteUser. 부분 실패 처리 포함. |
| src/app/api/cron/keep-alive/route.ts | modified | request 파라미터 추가 및 verifyCronSecret 인증 검증 적용. |
| src/shared/lib/cron-auth.ts | created | Vercel Cron Job CRON_SECRET 인증 검증 공유 유틸리티. verifyCronSecret(request) 함수. |
| src/shared/types/index.ts | modified | AccountDeletionResponse, CleanupUsersResponse 타입 추가. |
| vercel.json | modified | cleanup-users 크론 작업 추가 (매일 03:00 UTC). |
| .env.example | modified | CRON_SECRET 환경변수 항목 추가. |

### Frontend

| 파일 경로 | 변경 유형 | 설명 |
|-----------|-----------|------|
| src/shared/components/AccountDeleteModal.tsx | created | 회원 탈퇴 확인 모달. 경고 아이콘, 30일 유예 안내, '탈퇴합니다' 입력 검증, ESC 닫기, body 스크롤 잠금, 처리 중 스피너. |
| src/features/chat/ChatSidebar.tsx | modified | 유저 푸터에 회원 탈퇴 아이콘 버튼 추가. handleDeleteAccount 로직 + AccountDeleteModal 연동. |
| src/features/home/HomeClient.tsx | modified | 탈퇴 로직 Container 패턴. CollectionListView에 onDeleteAccount prop 전달. AccountDeleteModal 렌더링. |
| src/features/pdf/CollectionListView.tsx | modified | onDeleteAccount optional prop 추가. 유저 프로필 영역에 회원 탈퇴 아이콘 버튼 추가. |

## 주요 변경 사항

### 1. 소프트 딜리트 기반 회원 탈퇴

- profiles 테이블에 deleted_at, deletion_scheduled_at 컬럼 추가로 소프트 딜리트 구현
- 탈퇴 즉시 Supabase Auth ban 처리로 로그인 차단
- 30일 유예기간 후 크론으로 데이터 영구 삭제

### 2. 크론 보안 강화

- cron-auth.ts 공유 유틸리티로 모든 /api/cron/* 엔드포인트 CRON_SECRET 인증 통합
- 기존 keep-alive 크론에도 CRON_SECRET 검증 추가 (보안 개선)

### 3. 회원 탈퇴 확인 모달

- '탈퇴합니다' 텍스트 입력 검증으로 실수 방지
- 30일 유예기간 및 삭제 대상 데이터 안내
- ChatSidebar와 HomeClient 양쪽에서 접근 가능

## API 변경

| Method | Endpoint | 변경 내용 |
|--------|----------|-----------|
| POST | /api/account/delete | 신규 추가. 회원 탈퇴 소프트 딜리트 + Auth ban. 인증 필수. 응답: AccountDeletionResponse. |
| GET | /api/cron/cleanup-users | 신규 추가. 30일 경과 유저 영구 삭제 크론. CRON_SECRET 인증. 매일 03:00 UTC 실행. |
| GET | /api/cron/keep-alive | 수정. CRON_SECRET 인증 추가 (verifyCronSecret 유틸리티 적용). |

## DB 스키마 변경

### 변경 요약

| 변경 유형 | 대상 | 설명 | 파괴적 변경 |
|-----------|------|------|-------------|
| table_altered | profiles | deleted_at (TIMESTAMPTZ DEFAULT NULL), deletion_scheduled_at (TIMESTAMPTZ DEFAULT NULL) 컬럼 추가 | 아니오 |
| index_created | idx_profiles_deletion_scheduled | profiles(deletion_scheduled_at) 일반 B-tree 인덱스. cleanup_deleted_users RPC 쿼리 성능 최적화. | 아니오 |
| rpc_created | cleanup_deleted_users | 소프트 딜리트된 사용자의 Storage 파일 삭제 후 삭제 대상 user_id 배열(UUID[]) 반환. SECURITY DEFINER. | 아니오 |

### 마이그레이션 SQL

```sql
-- profiles 테이블에 소프트 딜리트 컬럼 추가
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMPTZ DEFAULT NULL;
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS deletion_scheduled_at TIMESTAMPTZ DEFAULT NULL;
```

```sql
-- 인덱스 추가
CREATE INDEX IF NOT EXISTS idx_profiles_deletion_scheduled ON profiles(deletion_scheduled_at);
```

```sql
-- cleanup_deleted_users RPC 함수 생성
CREATE OR REPLACE FUNCTION cleanup_deleted_users() RETURNS UUID[] LANGUAGE plpgsql SECURITY DEFINER AS $$ ... $$;
```

### 롤백 SQL

```sql
-- 롤백: RPC 함수 삭제
DROP FUNCTION IF EXISTS cleanup_deleted_users();
```

```sql
-- 롤백: 인덱스 삭제
DROP INDEX IF EXISTS idx_profiles_deletion_scheduled;
```

```sql
-- 롤백: 컬럼 삭제
ALTER TABLE profiles DROP COLUMN IF EXISTS deletion_scheduled_at;
ALTER TABLE profiles DROP COLUMN IF EXISTS deleted_at;
```

### 적용 방법

1. Supabase 대시보드 SQL Editor에서 마이그레이션 SQL을 실행합니다.
2. 실행 후 아래 확인사항을 점검합니다.
3. 문제 발생 시 롤백 SQL을 실행합니다.

### 확인사항

- [ ] 마이그레이션 SQL 실행 성공
- [ ] 새 테이블/컬럼이 정상 생성되었는지 확인
- [ ] RLS 정책이 올바르게 적용되었는지 확인
- [ ] RPC 함수가 정상 호출되는지 확인
- [ ] 기존 데이터에 영향 없는지 확인
- [ ] `supabase/schema.sql`이 최신 상태로 업데이트되었는지 확인

## 미해결 사항

| 항목 | 심각도 | 설명 |
|------|--------|------|
| ban 실패 시 롤백 없이 성공 응답 | medium | Auth ban이 실패해도 profiles 소프트 딜리트는 롤백하지 않고 성공 응답 반환. 크론에서 auth.users 삭제 시 처리됨. |
| alert() 대신 토스트 알림 권장 | low | 탈퇴 성공/실패 시 window.alert() 사용 중. 추후 토스트 컴포넌트로 교체 권장. |

## 후속 작업 권장

1. Vercel 대시보드에서 CRON_SECRET 환경변수 설정 필요
2. Supabase 대시보드에서 profiles 테이블 마이그레이션 SQL 실행 필요 (ALTER TABLE + CREATE INDEX + CREATE FUNCTION)
3. 탈퇴 취소(복구) 기능 검토 (30일 이내 재가입 시 데이터 복원)
4. alert() 대신 토스트 알림 컴포넌트 도입
5. 탈퇴 사유 수집 기능 검토 (선택사항)

---
*생성: Orchestrator | 일시: 2026-02-10 13:30*
