# 요청 분석: 20260210-회원탈퇴-30일삭제

## 작업 개요

| 항목 | 내용 |
|------|------|
| **작업 ID** | 20260210-회원탈퇴-30일삭제 |
| **분석 일시** | 2026-02-10 12:00 |
| **요청 요약** | 회원 탈퇴 기능 추가. 탈퇴 시 소프트 딜리트 방식으로 즉시 비활성화하고, 30일 유예기간 후 DB 및 Storage의 모든 사용자 데이터를 영구 삭제합니다. |

## 요구사항

### 기능 요구사항

1. 사용자가 UI에서 회원 탈퇴를 요청할 수 있어야 함
2. 탈퇴 요청 시 즉시 로그인 차단 (Supabase Auth ban 처리)
3. 탈퇴 후 30일 유예기간 동안 데이터 보존
4. 30일 경과 후 모든 사용자 데이터 영구 삭제 (profiles, pdf_documents, chat_sessions, chat_messages, credit_usage_logs, Storage 파일)
5. 탈퇴 확인 모달에 30일 유예기간 안내 표시
6. 크론 작업으로 30일 경과 유저 자동 정리

### 비기능 요구사항

- 데이터 삭제의 무결성 보장 (Storage 파일 포함)
- 탈퇴 유저의 즉시 접근 차단 (토큰 무효화)
- 기존 ON DELETE CASCADE 관계 활용으로 효율적 삭제

## 작업 범위

| 영역 | 작업 내용 |
|------|-----------|
| **Schema** | profiles 테이블에 deleted_at, deletion_scheduled_at 컬럼 추가. cleanup_deleted_users RPC 함수 생성. 마이그레이션/롤백 SQL 제공. |
| **Backend** | POST /api/account/delete (소프트 딜리트 + Auth ban), GET /api/cron/cleanup-users (30일 경과 유저 영구 삭제) API 구현 |
| **Frontend** | 회원 탈퇴 접근점 (사이드바/홈 프로필 영역), 탈퇴 확인 모달 (30일 안내), 탈퇴 처리 및 리다이렉트 |

## 완료 조건

- [ ] 사용자가 UI에서 회원 탈퇴를 요청할 수 있다
- [ ] 탈퇴 요청 시 profiles.deleted_at이 설정되고 Supabase Auth에서 ban 처리된다
- [ ] 탈퇴 유저는 즉시 로그인이 차단된다
- [ ] 30일 경과 후 크론 실행 시 해당 유저의 모든 데이터가 삭제된다
- [ ] 탈퇴 확인 모달에 30일 유예기간 안내가 표시된다
- [ ] 기존 디자인 시스템과 일관된 UI

## 실행 계획

| 순서 | 에이전트 | 작업 내용 |
|------|----------|-----------|
| 1 | supabase-schema-developer | profiles 테이블 소프트 딜리트 컬럼 추가 및 cleanup_deleted_users RPC 함수 생성 |
| 2 | backend-developer | 회원 탈퇴 API (POST /api/account/delete) 및 크론 정리 API (GET /api/cron/cleanup-users) 구현 |
| 3 | frontend-developer | 회원 탈퇴 UI (접근점, 확인 모달, 탈퇴 처리) |
| 4 | reviewer | 전체 기능 코드 품질, 보안, 데이터 무결성 검증 |

## 리스크 및 주의사항

- Supabase Auth admin.deleteUser는 service_role 키가 필요하며 서버에서만 실행 가능
- Storage 파일 삭제는 CASCADE 대상이 아니므로 누락 가능성 있음
- 탈퇴 유저의 기존 JWT 토큰이 만료 전까지 유효할 수 있음 (ban 처리로 대응)
- Vercel Cron의 실행 빈도 제한 확인 필요 (무료 플랜: 1일 1회)
- 30일 정리 크론이 실패할 경우 재시도 메커니즘 필요

---
*생성: Orchestrator | 일시: 2026-02-10 12:00*
