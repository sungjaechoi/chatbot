# reviewer.md 에이전트 상태 평가

> 작성일: 2026-02-09
> 평가 대상: `.claude/agents/reviewer.md`
> 비교 기준: `doc/변경사항_요약_Supabase_마이그레이션.md`, 실제 코드베이스

---

## 1. 평가 요약

| 항목 | 판정 |
|------|------|
| **전체 상태** | **부분 불일치 (PARTIALLY OUTDATED)** |
| YAML description | 유효 (범용적 기술) |
| 역할 설명 (본문 첫 문단) | "LangChain + 로컬 Chroma" 참조 — **불일치** |
| 리뷰 범위 | "Chroma 로컬 persist" 검증 항목 — **무효** |
| 절대 규칙 | 유효 (범용적 원칙) |
| 오탐 방지 규칙 | 유효 |
| 출력 형식 | 유효 |
| PASS/FAIL 기준 | 유효 (범용적 기준) |

**불일치율: 약 25~30%** (backend-developer.md의 55~60%보다 낮음)

---

## 2. 항목별 상세 분석

### 2.1 역할 설명 (본문 첫 문단)

**현재 (`reviewer.md` 10행)**
```
당신의 역할은 백엔드(Next.js 서버 RAG: LangChain + 로컬 Chroma)부터 프론트(UI)까지
전체 작업 결과를 매우 엄격하게 검증하고, PASS/FAIL을 판정하는 것입니다.
```

**실제 코드베이스**
- LangChain은 극소 범위만 사용 (임베딩은 Vercel AI SDK로 전환)
- ChromaDB 완전 제거 → Supabase pgvector
- 인증 시스템 추가 (Supabase Auth + Google OAuth)

**판정**: "Supabase pgvector + Vercel AI SDK 기반 RAG" 로 수정 필요

---

### 2.2 리뷰 범위

**현재 (`reviewer.md` 18행)**
```
백엔드: API 설계, 에러 처리, 보안(키 노출), 런타임(Node),
        RAG 파이프라인(리트리버/프롬프트), Chroma 로컬 persist, 성능(불필요 호출)
```

| 리뷰 항목 | 실제 대응 | 상태 |
|-----------|----------|------|
| API 설계 | Route Handler 그대로 | 유효 |
| 에러 처리 | try-catch + ErrorResponse 타입 | 유효 |
| 보안(키 노출) | 환경변수 사용 | 유효 |
| 런타임(Node) | `runtime = 'nodejs'` | 유효 |
| RAG 파이프라인(리트리버/프롬프트) | Supabase RPC 기반 retriever | 부분 유효 |
| **Chroma 로컬 persist** | **존재하지 않음** | **무효** |
| 성능(불필요 호출) | 유효 | 유효 |

**누락된 리뷰 항목** (마이그레이션으로 추가된 것들):

| 누락 항목 | 설명 | 중요도 |
|-----------|------|--------|
| **인증 검증** | 모든 API에서 `getUser()` 확인 여부 | **P0** |
| **RLS 정합성** | Admin/Server Client 사용 구분이 적절한지 | **P0** |
| **Supabase Client 선택** | Admin vs Server vs Browser 적절성 | **P1** |
| **Storage 접근 권한** | 사용자 폴더 격리 (`userId/pdfId.pdf`) | **P1** |
| **RPC 함수 호출** | `match_documents`, `get_user_collections` 파라미터 정합성 | **P1** |
| **미들웨어 연동** | 세션 갱신 + 리다이렉트 로직 | **P2** |
| **채팅 기록 영속화** | 세션/메시지 저장 로직 검증 | **P2** |

**판정**: "Chroma 로컬 persist" 제거 + Supabase 관련 리뷰 항목 6개 추가 필요

---

### 2.3 절대 규칙

```
- 코드 변경을 직접 하지 않습니다.
- 기준 미달이면 반드시 FAIL로 판정합니다.
- 중대한 문제(보안/데이터 유출/런타임 불일치/스키마 불일치/치명적 버그)가 있으면 즉시 FAIL입니다.
```

**판정**: 완전히 유효. 변경 불필요.

---

### 2.4 오탐 방지 규칙

| 규칙 | 상태 |
|------|------|
| 빌드 성공 확인됨 → non_blocker | 유효 |
| 프레임워크 컨벤션 → PASS | 유효 |
| 상대 경로 사용 → 빌드 성공 시 유효 | 유효 |
| CSS 변수 연결 → PASS | 유효 |

**판정**: 완전히 유효. 변경 불필요.

**추가 고려**: Supabase 패턴에 대한 오탐 방지 규칙이 필요할 수 있음:
- `createAdminClient()` 사용이 적절한 곳 (서버 전용 RLS 우회) → 보안 이슈가 아님
- `@supabase/ssr`의 쿠키 패턴 → 프레임워크 공식 패턴

---

### 2.5 출력 형식

```json
{
  "verdict": "PASS | FAIL",
  "summary": "...",
  "build_verified": true | false,
  "blockers": [...],
  "non_blockers": [...],
  "acceptance_check": [...]
}
```

**판정**: 완전히 유효. 스키마 변경 불필요.

---

### 2.6 PASS/FAIL 기준

| 기준 | 상태 |
|------|------|
| 완료 조건 모두 충족 | 유효 |
| 치명적/높은 수준 이슈 0개 | 유효 |
| 통합 스키마 불일치 없음 | 유효 |
| 보안 이슈 없음 | 유효 |

**판정**: 완전히 유효. 단, "보안 이슈"의 범위에 RLS 우회 패턴, Admin Client 오남용 등이 포함되어야 함.

---

## 3. 불일치 수준 요약

```
섹션별 불일치율:

YAML description   ░░░░░░░░░░░░░░░░░░░░   0% (유효)
역할 설명 (첫 문단) ████████████████████ 100% 불일치
리뷰 범위           ████████░░░░░░░░░░░░  40% 불일치 (1항목 무효 + 6항목 누락)
절대 규칙           ░░░░░░░░░░░░░░░░░░░░   0% (유효)
오탐 방지           ░░░░░░░░░░░░░░░░░░░░   0% (유효, 추가 고려)
FAIL 체크리스트     ░░░░░░░░░░░░░░░░░░░░   0% (유효)
출력 형식           ░░░░░░░░░░░░░░░░░░░░   0% (유효)
PASS/FAIL 기준      ░░░░░░░░░░░░░░░░░░░░   0% (유효)
```

---

## 4. backend-developer.md 평가와 비교

| 비교 항목 | backend-developer.md | reviewer.md |
|-----------|---------------------|-------------|
| 전체 불일치율 | ~55-60% | ~25-30% |
| 무효 섹션 수 | 1개 (섹션 4 전체) | 0개 (부분 무효만) |
| ChromaDB 직접 참조 | 6곳 이상 | 2곳 |
| 구조적 재설계 필요 | 예 (3개 섹션) | 아니오 (수정만) |
| 누락된 핵심 개념 | 9개 (Auth, RLS, Storage 등) | 6개 (리뷰 항목) |

**reviewer.md는 범용적으로 작성된 부분이 많아 backend-developer.md보다 영향이 적음.**
그러나 리뷰 범위에 인증/RLS 등 핵심 보안 검증 항목이 누락된 것은 **실질적 위험**이 있음.

---

## 5. 결론 및 권고

### 판정: 부분 업데이트 필요

reviewer.md는 전체 구조는 건전하나, **리뷰 범위가 현재 아키텍처를 반영하지 못함**.

이 상태로 에이전트를 사용할 경우:
- Supabase Auth 인증 누락을 검출하지 못할 위험
- Admin Client 오남용(RLS 우회가 불필요한 곳에서 사용)을 놓칠 위험
- Storage 접근 권한 문제를 리뷰하지 않을 위험
- 존재하지 않는 "Chroma 로컬 persist"를 검증하려 시도할 위험

### 권고 업데이트 항목 (우선순위순)

| 우선순위 | 항목 | 작업 |
|---------|------|------|
| **P0** | 역할 설명 (첫 문단) | "LangChain + 로컬 Chroma" → "Supabase pgvector + Vercel AI SDK" |
| **P0** | 리뷰 범위 — 백엔드 | "Chroma 로컬 persist" 제거, 인증/RLS/Storage 항목 추가 |
| **P1** | 오탐 방지 규칙 | Supabase 패턴 관련 오탐 방지 규칙 추가 |
| **P2** | FAIL 체크리스트 | "인증 누락" 항목 추가 |
