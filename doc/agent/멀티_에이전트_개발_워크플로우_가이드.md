# 멀티 에이전트 개발 워크플로우 가이드

## 개요

이 워크플로우는 **오케스트레이터 중심의 멀티 에이전트 개발 파이프라인**입니다. 사용자의 요청을 받아 백엔드 개발, 프론트엔드 개발, 코드 리뷰를 순차적으로 진행하며, 모든 에이전트 간 통신은 반드시 오케스트레이터를 통해 이루어집니다.

---

## 파이프라인 실행 순서

```
사용자 프롬프트
      │
      ▼
┌─────────────────┐
│  Orchestrator   │ ← 작업 분석 & 초기화
│   (초기화)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│    Backend      │ ← RAG 백엔드 로직 구현
│   Developer     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Orchestrator   │ ← 결과 수신 & 다음 지시
│   (resume)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   Frontend      │ ← UI 컴포넌트 구현
│   Developer     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Orchestrator   │ ← 결과 수신 & 다음 지시
│   (resume)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│    Reviewer     │ ← 전체 코드 검증
└────────┬────────┘
         │
         ▼
    ┌────┴────┐
    │         │
  PASS      FAIL
    │         │
    ▼         ▼
  완료    재작업 루프
         (최대 2회)
```

---

## 각 에이전트 중점 사항

### 1. Orchestrator (오케스트레이터)

**역할**: 전체 워크플로우의 지휘자

| 구분 | 내용 |
|------|------|
| **핵심 책임** | 작업 분석, 에이전트 호출 순서 결정, 결과 수신 및 전달, 상태 관리 |
| **상태 추적** | `phase`, `fix_round`, `pending_blockers` 관리 |
| **문서화** | `01-요청분석.md`, `99-최종결과보고.md` 생성 지시 |

**핵심 프롬프트**:

> 이 워크플로우는 구현을 수행하지 않습니다.
> 사용자 프롬프트를 수정하지 않고 그대로 전달합니다.
> 사용자에게 플랜을 보여주고 동의를 구하지 않습니다.
> 모든 에이전트 호출은 오케스트레이터를 통해서만 이루어집니다.

**상태 관리 구조**:

```json
{
  "phase": "backend | frontend | review | fix_backend | fix_frontend | done",
  "fix_round": 0,
  "max_fix_round": 2,
  "pending_blockers": {
    "backend": [],
    "frontend": [],
    "integration": []
  }
}
```

**단계 생략 규칙**:
- 순수 프론트엔드 작업 → Backend 생략 가능
- 순수 백엔드 작업 → Frontend 생략 가능
- 생략 시 반드시 `skipped_phases`에 기록하고 사유 명시

---

### 2. Backend Developer (백엔드 개발자)

**역할**: Next.js 서버사이드 RAG 백엔드 구현

| 구분 | 내용 |
|------|------|
| **기술 스택** | Next.js App Router, LangChain, Chroma (로컬 DB) |
| **핵심 책임** | RAG 파이프라인 구성 (문서 로딩 → 청킹 → 임베딩 → 저장 → 검색 → LLM 호출) |
| **런타임** | Node runtime (Edge runtime 사용 금지) |

**핵심 프롬프트**:

> 당신은 시니어 백엔드 디벨로퍼 에이전트입니다.
> 당신의 전문 분야는 Next.js 서버사이드(주로 App Router의 Route Handler)에서
> Next AI Gateway + LangChain을 활용해 RAG(Retrieval-Augmented Generation) 서비스 로직을 구현하는 것입니다.
>
> 이 프로젝트의 벡터 스토어는 "Chroma (로컬 DB)"를 사용합니다.
> 외부 호스팅 Chroma(클라우드)나 다른 벡터DB로 변경을 제안하지 않습니다.

**역할 경계 (최우선 준수)**:

```
1. 오케스트레이터가 전달한 요구사항을 "구현"만 합니다.
2. 작업 순서를 결정하거나 범위를 확장하지 않습니다.
3. 다른 에이전트에게 일을 위임하지 않습니다.
4. 작업 완료 후, 다음 단계를 스스로 결정하지 않습니다.
5. 재작업이 필요하다고 판단되어도, 오케스트레이터의 지시 없이 스스로 수정하지 않습니다.
```

**필수 준수 사항**:

```
보안
├── API Key는 환경변수에서만 로드
├── 환경변수 미설정 시 명확한 에러
├── 사용자 입력 검증
└── 에러 응답에 내부 구현 노출 금지

에러 처리
├── 모든 외부 호출에 try-catch
├── 의미 있는 에러 메시지
└── 적절한 HTTP 상태 코드

타입 안전성
├── any 타입 사용 금지
├── API 요청/응답 스키마 타입 정의
└── 공유 타입은 shared/types에 정의

코드 정리
├── 미사용 import/변수/함수 제거
├── console.log 제거
└── 주석 처리된 코드 제거
```

**Chroma 설계 원칙**:
- collection 이름은 명확하고 고정
- metadata에 `source`, `chunk_index`, `page`, `created_at` 포함
- chunking 전략은 상수 또는 환경변수로 조절 가능하게 설계

---

### 3. Frontend Developer (프론트엔드 개발자)

**역할**: Next.js App Router 기반 UI 구현

| 구분 | 내용 |
|------|------|
| **기술 스택** | Next.js App Router, React, TypeScript, Tailwind CSS |
| **핵심 책임** | UI 컴포넌트 구현, 상태 관리, API 연동 |
| **아키텍처** | Container/Presentation 패턴 필수 |

**핵심 프롬프트**:

> 당신은 시니어 프론트엔드 디벨로퍼 에이전트입니다.
> 당신의 전문 분야는 Next.js(App Router) + React + TypeScript 환경에서
> UI 컴포넌트와 상태 관리를 구현하고, 백엔드 API와 안정적으로 연동하는 것입니다.

**역할 경계 (최우선 준수)**:

```
1. 오케스트레이터가 전달한 요구사항을 "구현"만 합니다.
2. 작업 순서를 결정하거나 범위를 확장하지 않습니다.
3. 다른 에이전트에게 일을 위임하지 않습니다.
4. 작업 완료 후, 다음 단계를 스스로 결정하지 않습니다.
5. 재작업이 필요하다고 판단되어도, 오케스트레이터의 지시 없이 스스로 수정하지 않습니다.
6. 백엔드 로직을 대신 구현하지 않습니다.
```

**절대 규칙**:
- 기능 요구사항을 임의로 추가하거나 범위를 확장하지 않습니다.
- 백엔드 로직을 대신 구현하지 않습니다.
- API Key 등 민감정보는 절대 클라이언트에 노출하지 않습니다.
- 서버 전용 코드를 클라이언트 번들에 포함시키지 않습니다.

**폴더 구조**:

```
src/features/{feature-name}/
├── containers/
│   └── {Feature}Container.tsx    # 상태, API 호출
└── components/
    └── {Feature}View.tsx         # UI 렌더링만
```

**UX 필수 상태 처리**:

| 상태 | 처리 |
|------|------|
| 로딩 | 스피너, 스켈레톤 표시 |
| 에러 | UI 에러 메시지 (alert() 대신 컴포넌트) |
| 빈 상태 | "데이터 없음" 표시 |
| 비활성화 | 버튼 disabled (로딩 중, 유효하지 않은 입력) |

**API 연동 패턴**:

```typescript
const response = await fetch("/api/chat", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ pdfId, message }),
});

if (!response.ok) {
  let errorMessage = "Unknown error";
  try {
    const errorData = await response.json();
    errorMessage = errorData.error || errorMessage;
  } catch {
    // JSON 파싱 실패 시 기본 메시지
  }
  throw new Error(errorMessage);
}
```

---

### 4. Reviewer (리뷰어)

**역할**: 전체 작업 결과의 엄격한 품질 검증

| 구분 | 내용 |
|------|------|
| **리뷰 범위** | 백엔드, 프론트엔드, 통합 |
| **출력** | JSON 형식 (verdict, blockers, non_blockers) |
| **판정** | PASS 또는 FAIL |

**핵심 프롬프트**:

> 당신은 "엄격한 코드/시스템 리뷰어" 에이전트입니다.
> 당신의 역할은 백엔드(Next.js 서버 RAG: LangChain + 로컬 Chroma)부터 프론트(UI)까지
> 전체 작업 결과를 매우 엄격하게 검증하고, PASS/FAIL을 판정하는 것입니다.
>
> 당신은 구현(코드 작성/파일 수정/명령 실행)을 절대 하지 않습니다.
> 오직 리뷰/검증/지적/수정 지시 작성만 합니다.

**절대 규칙**:

```
- 코드 변경을 직접 하지 않습니다. "어디를 어떻게 고쳐라"만 제시합니다.
- 기준 미달이면 반드시 FAIL로 판정합니다. 애매하면 FAIL입니다.
- 중대한 문제(보안/데이터 유출/런타임 불일치/스키마 불일치/치명적 버그)가 있으면 즉시 FAIL입니다.
```

**리뷰 범위 상세**:

| 영역 | 검증 항목 |
|------|-----------|
| **백엔드** | API 설계, 에러 처리, 보안(키 노출), 런타임(Node), RAG 파이프라인, Chroma 로컬 persist, 성능 |
| **프론트엔드** | 상태 관리, 요청/응답 타입, 스트리밍 처리, 로딩/에러/빈 상태, UX, 접근성, 민감정보 노출 |
| **통합** | FE↔BE 계약(스키마), 실패 케이스, 일관성, 완료 조건 충족 여부 |

**FAIL 판정 전 체크리스트**:

```
□ 빌드가 실패하는가? → blocker
□ 런타임 에러가 발생하는가? → blocker
□ 보안 취약점이 있는가? → blocker
□ 데이터 손실/유출 가능성이 있는가? → blocker
□ 위 모두 아니면 → non_blocker 고려
```

**오탐 방지 규칙**:
- 빌드 성공 확인됨 → 경로/설정 이슈는 non_blocker
- 프레임워크 컨벤션 (Next.js, Tailwind 공식 패턴) → PASS
- 상대 경로 사용이 빌드 성공 시 → 유효로 판단

**출력 형식**:

```json
{
  "verdict": "PASS | FAIL",
  "summary": "전체 평가 요약",
  "build_verified": true | false,
  "blockers": [...],
  "non_blockers": [...],
  "acceptance_check": [...]
}
```

---

## 재작업 루프 (FAIL 시)

```
Reviewer FAIL
      │
      ▼
Orchestrator가 blockers를 area별 분류
      │
      ├── backend blockers ──▶ Backend Developer 재작업
      │                              │
      │                              ▼
      │                        Orchestrator
      │
      └── frontend blockers ─▶ Frontend Developer 재작업
                                     │
                                     ▼
                               Orchestrator
                                     │
                                     ▼
                                 Reviewer
                                     │
                              ┌──────┴──────┐
                              │             │
                            PASS          FAIL
                              │             │
                            완료      반복 (최대 2회)
```

---

## 에이전트 호출 규칙

| 호출 주체 | 호출 가능 대상 |
|-----------|----------------|
| Workflow | Orchestrator만 |
| Orchestrator | Backend, Frontend, Reviewer |
| Backend | 없음 (결과만 반환) |
| Frontend | 없음 (결과만 반환) |
| Reviewer | 없음 (결과만 반환) |

**핵심 원칙**: Backend, Frontend, Reviewer는 서로 직접 호출 불가. 모든 전환은 Orchestrator를 통해 이루어짐.

---

## 문서화 규칙

| 시점 | 파일 | 내용 |
|------|------|------|
| 초기화 후 | `01-요청분석.md` | 요청 분석 결과 |
| 완료 시 | `99-최종결과보고.md` | 최종 결과 보고 |

메인 LLM은 Orchestrator의 `documentation_content`를 확인하여 `should_write === true`인 경우 반드시 해당 문서를 작성해야 합니다.

---

## 핵심 금지 패턴

| 금지 | 올바른 방식 |
|------|-------------|
| ❌ Reviewer FAIL → Backend 직접 수정 | ✅ FAIL → Orchestrator → Backend → Orchestrator |
| ❌ 에이전트가 다음 단계 결정 | ✅ Orchestrator만 워크플로우 결정 |
| ❌ 에이전트가 범위 확장 | ✅ 오케스트레이터 지시 범위만 구현 |
| ❌ 에이전트 간 직접 호출 | ✅ 모든 통신은 Orchestrator 경유 |

---

## 실제 실행 예시: PDF 업로드 후 챗봇 전환 기능

아래는 실제 워크플로우 실행 결과입니다. 이 예시를 통해 워크플로우가 어떻게 동작하는지 이해할 수 있습니다.

### 실행 타임라인

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📋 요청: "루트(/)와 챗봇 화면에서 새 PDF 업로드 시 해당 PDF로 챗봇 전환"      │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 1: 초기화                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  ⏺ Orchestrator (초기화)                                                    │
│     └─ 작업 분석 완료 (16 tool uses · 1m 8s)                                │
│                                                                             │
│  📄 문서 작성: 01-요청분석.md                                                │
│     └─ 작업 개요, 완료 조건, 기술 스택 정의                                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 2: Backend 개발                                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  ⏺ backend-developer (API 검토)                                             │
│     └─ 기존 API 검토 완료 (18 tool uses · 1m 51s)                           │
│     └─ 결과: 백엔드 변경 불필요 (기존 API로 충분)                            │
│                                                                             │
│  ⏺ Orchestrator (resume)                                                    │
│     └─ Backend 결과 수신, Frontend 작업 지시                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 3: Frontend 개발                                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  ⏺ frontend-developer (자동 전환 구현)                                      │
│     └─ PDF 업로드 후 라우팅 로직 구현 (13 tool uses · 1m 13s)               │
│                                                                             │
│  ⏺ Orchestrator (resume)                                                    │
│     └─ Frontend 결과 수신, Reviewer 호출 지시                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 4: 1차 리뷰                                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  ⏺ reviewer (1차 검증)                                                      │
│     └─ 검증 완료 (19 tool uses · 1m 27s)                                    │
│     └─ 결과: ❌ FAIL                                                        │
│     └─ Blockers: pdfId 유효성 검증 미흡, 에러 처리 부족                     │
│                                                                             │
│  ⏺ Orchestrator (resume)                                                    │
│     └─ FAIL 수신, blockers 분석, 재작업 지시 생성                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 5: 1차 재작업 (fix_round: 1)                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│  ⏺ frontend-developer (이슈 수정)                                           │
│     └─ pdfId 유효성 검증 추가 (5 tool uses · 46s)                           │
│                                                                             │
│  ⏺ Orchestrator (resume)                                                    │
│     └─ 수정 결과 수신, 2차 리뷰 지시                                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 6: 2차 리뷰                                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  ⏺ reviewer (2차 검증)                                                      │
│     └─ 검증 완료 (2 tool uses · 40s)                                        │
│     └─ 결과: ❌ FAIL                                                        │
│     └─ Blockers: 추가 에러 처리 필요                                        │
│                                                                             │
│  ⏺ Orchestrator (resume)                                                    │
│     └─ FAIL 수신, 마지막 재작업 지시 (fix_round: 2)                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 7: 2차 재작업 (fix_round: 2) - 마지막 기회                            │
├─────────────────────────────────────────────────────────────────────────────┤
│  ⏺ frontend-developer (Critical/High 이슈 해결)                             │
│     └─ 모든 이슈 수정 완료 (10 tool uses · 59s)                             │
│                                                                             │
│  ⏺ Orchestrator (resume)                                                    │
│     └─ 수정 결과 수신, 최종 리뷰 지시                                       │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 8: 최종 리뷰 (3차)                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│  ⏺ reviewer (최종 검증)                                                     │
│     └─ 검증 완료 (2 tool uses · 18s)                                        │
│     └─ 결과: ✅ PASS                                                        │
│                                                                             │
│  ⏺ Orchestrator (resume)                                                    │
│     └─ PASS 수신, 워크플로우 완료 처리                                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 9: 완료                                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  📄 문서 작성: 99-최종결과보고.md                                            │
│     └─ 구현 결과, 수정 이력, 파일 목록 기록                                 │
│                                                                             │
│  ✅ 워크플로우 종료                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 실행 흐름과 워크플로우 규칙 매핑

| 실행 단계 | 워크플로우 규칙 | 설명 |
|-----------|-----------------|------|
| Orchestrator 초기화 → 문서 작성 | **문서화 규칙** | `should_write === true` 시 `01-요청분석.md` 작성 |
| Backend → Orchestrator → Frontend | **에이전트 호출 규칙** | 모든 전환은 Orchestrator 경유 |
| Reviewer FAIL → Orchestrator → Frontend | **재작업 루프** | 직접 수정 금지, Orchestrator 통해 지시 |
| fix_round 2까지 반복 | **max_fix_round: 2** | 최대 2회 재작업 후 종료 |
| PASS → 문서 작성 | **문서화 규칙** | `99-최종결과보고.md` 작성 |

### 재작업 루프 상세 분석

이 예시에서 재작업 루프가 **2회** 발생했습니다:

```
┌─────────────────────────────────────────────────────────────────┐
│                      재작업 루프 흐름                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1차 리뷰 FAIL                                                  │
│       │                                                         │
│       ▼                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Orchestrator: blockers 분석                              │   │
│  │ ├─ backend blockers: 없음                                │   │
│  │ └─ frontend blockers: pdfId 유효성 검증 미흡            │   │
│  └─────────────────────────────────────────────────────────┘   │
│       │                                                         │
│       ▼                                                         │
│  Frontend Developer: pdfId 검증 추가 (fix_round: 1)            │
│       │                                                         │
│       ▼                                                         │
│  2차 리뷰 FAIL                                                  │
│       │                                                         │
│       ▼                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Orchestrator: blockers 분석                              │   │
│  │ └─ frontend blockers: 추가 에러 처리 필요               │   │
│  └─────────────────────────────────────────────────────────┘   │
│       │                                                         │
│       ▼                                                         │
│  Frontend Developer: Critical/High 이슈 해결 (fix_round: 2)    │
│       │                                                         │
│       ▼                                                         │
│  3차 리뷰 PASS ✅                                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**핵심 포인트**:
- Backend blockers가 없어서 Backend Developer 재호출 생략
- Frontend blockers만 있어서 Frontend Developer만 재작업
- Orchestrator가 blockers를 area별로 분류하여 효율적 재작업 지시

### 에이전트별 호출 통계

| 에이전트 | 호출 횟수 | 총 소요 시간 | 역할 |
|----------|-----------|--------------|------|
| **Orchestrator** | 7회 | ~3분 21초 | 분석, resume, 상태 관리 |
| **Backend Developer** | 1회 | 1분 51초 | API 검토 (변경 불필요 판단) |
| **Frontend Developer** | 3회 | 2분 58초 | 최초 구현 + 2회 재작업 |
| **Reviewer** | 3회 | 2분 25초 | 1차 FAIL + 2차 FAIL + 3차 PASS |

### 상태 전이 다이어그램

```
                    ┌─────────┐
                    │  init   │
                    └────┬────┘
                         │
                         ▼
                    ┌─────────┐
                    │ backend │
                    └────┬────┘
                         │
                         ▼
                    ┌─────────┐
                    │frontend │
                    └────┬────┘
                         │
                         ▼
                    ┌─────────┐
              ┌─────│ review  │─────┐
              │     └─────────┘     │
              │                     │
           PASS                   FAIL
              │                     │
              ▼                     ▼
         ┌────────┐          ┌───────────┐
         │  done  │          │fix_frontend│◄──┐
         └────────┘          └─────┬─────┘   │
                                   │         │
                                   ▼         │
                              ┌─────────┐    │
                              │ review  │────┘
                              └────┬────┘  (FAIL, fix_round < 2)
                                   │
                                   │ (PASS 또는 fix_round >= 2)
                                   ▼
                              ┌────────┐
                              │  done  │
                              └────────┘
```

### 이 예시에서 확인할 수 있는 워크플로우 특징

1. **Orchestrator 중심 제어**: 모든 에이전트 전환이 Orchestrator를 통해 이루어짐
2. **단계 생략**: Backend 변경이 불필요하여 Backend 재작업 단계 생략
3. **점진적 품질 향상**: 1차 → 2차 → 3차 리뷰를 통해 품질 기준 충족
4. **명확한 문서화**: 시작과 끝에 요청분석/최종결과 문서 자동 생성
5. **최대 재작업 제한**: `max_fix_round: 2` 설정으로 무한 루프 방지
